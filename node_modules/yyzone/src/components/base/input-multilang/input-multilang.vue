
<template>
    <div
        :class="classes"
        v-click-outside.capture="handleCloseDrop"
        v-click-outside:mousedown.capture="handleCloseDrop">
        <div ref="reference">
            <InputMultiLangHead 
                v-model="values[langType]"
                :type="type"
                :clearable="clearable"
                :disabled="disabled"
                :readonly="readonly"
                :size="size"
                :isFocused="isFocused"
                :placeholder="placeholder"
                :maxlength="maxlength"
                :rows="rows"
                @on-change="handleChange"
                @click="handleToggleDrop"/>
        </div>
        <transition name="transition-drop">
            <Dropdown 
                ref="dropdown"
                v-show="dropVisible">
                <InputMultiLangDrop 
                    v-model="values"
                    :type="type"
                    :lang="langType"
                    :clearable="clearable"
                    :maxlength="maxlength"
                    @on-cancel="handleCancel"
                    @on-ok="handleOk"/>
            </Dropdown>
        </transition>
    </div>
</template>
<script>
    import Dropdown from '../select/dropdown'
    import InputMultiLangHead from './input-multilang-head'
    import InputMultiLangDrop from './input-multilang-drop'
    import ClickOutside from '../../../directives/clickoutside'
    import Emitter from '../../../mixins/emitter'
    import Locale from '../../../mixins/locale'
    import { deepCopy, oneOf } from '../../../utils/assist'
    import { getLang, t } from '../../../locale/'
    const prefixCls = 'yy-input-multilang'

    export default {
        name: 'YYInputMultiLang',
        mixins: [Emitter, Locale],
        components: {
            Dropdown,
            InputMultiLangHead,
            InputMultiLangDrop
        },
        directives: {
            ClickOutside
        },
        props: {
            value: {
                type: [String, Object],
                default: () => {
                    return {
                        zhs: '',
                        zht: '',
                        en: ''
                    }
                }
            },
            type: {
                validator(value) {
                    return oneOf(value, ['text', 'textarea'])
                },
                default: 'text'
            },
            size: {
                validator(value) {
                    return oneOf(value, ['small', 'large'])
                }
            },
            lang: {
                type: String,
                default: getLang()
            },
            maxlength: {
                type: Number
            },
            disabled: {
                type: Boolean,
                default: false
            },
            readonly: {
                type: Boolean,
                default: false
            },
            clearable: {
                type: Boolean,
                default: false
            },
            placeholder: {
                type: String,
                default: () => {
                    return t('enterTheContent')
                }
            },
            rows: {
                type: Number,
                default: 4
            }
        },
        data() {
            return {
                prefixCls: prefixCls,
                slotOptions: this.$slots.default,
                dropVisible: false,
                filterQueryChange: false,
                query: '',
                isFocused: false,
                values: deepCopy(this.value),
                langType: ''
            }
        },
        computed: {
            classes() {
                return [
                    `${prefixCls}`,
                    {
                        [`${prefixCls}-disabled`]: this.disabled,
                        [`${prefixCls}-readonly`]: this.readonly,
                        [`${prefixCls}-focus`]: this.isFocused
                    }
                ]
            }
        },
        watch: {
            value(newValue) {
                this.values = deepCopy(newValue)
            }
        },
        methods: {
            handleToggleDrop() {
                this.broadcast('YYSelectDrop', 'on-update-popper')
                this.dropVisible = !this.dropVisible
                this.isFocused = this.dropVisible
            },
            handleCloseDrop() {
                this.dropVisible = false
                this.isFocused = this.dropVisible
                this.dispatch('YYFormItem', 'on-form-change', this.values[this.lang])
            },
            handleChange(value) {
                this.$set(this.values, this.lang, value)
                this.$emit('input', this.values)
                this.$emit('on-change', this.values)
            },
            handleCancel() {
                this.handleCloseDrop()
                this.values = deepCopy(this.value)
            },
            handleOk() {
                this.handleCloseDrop()
                this.$emit('input', this.values)
                this.$emit('on-change', this.values)
            }
        },
        created() {
            this.langType = this.lang || getLang()
        }
    }
</script>

