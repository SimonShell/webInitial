<template>
    <div :class="prefixCls">
        <div :class="prefixCls + '-choose'">
            <Upload
                :before-upload="beforeUpload"
                :show-upload-list="false"
                :max-size="maxSize"
                multiple
                action="security-upload">
                <YYButton type="ghost">选择文件</YYButton>
                <span :class="prefixCls + '-choose-tips'">(单个附件最多{{maxSize/1024}}M)</span>
            </Upload>
            <div :class="prefixCls + '-choose-content'">
                <slot name="chooseContent"></slot>
            </div>
        </div>
        <div :class="prefixCls + '-drag'" v-if="showDrag">
            <Upload
                :before-upload="beforeUpload"
                :show-upload-list="false"
                :max-size="maxSize"
                action="security-upload"
                multiple
                type="drag">
                <div :class="prefixCls + '-drag-content'">
                    <slot name="dragContent" v-if="!fileFormData.length">
                        <span :class="prefixCls + '-drag-content-text'">文件拖动到此上传</span>
                    </slot>
                    <div :class="prefixCls + '-drag-list'" ref="sortableWrapper" v-else>
                        <div 
                            @click.stop
                            v-for="(item, index) in fileFormData"
                            :class="[prefixCls + '-item', 'sortable-item']" 
                            :key="item.fileName">
                            <YYRadioGroup v-model="item.security" v-if="!disabledSecurity">
                                <YYRadio 
                                    v-for="(value, key) in fileSecurity" 
                                    :key="key" 
                                    :label="key">{{value.text}}</YYRadio>
                            </YYRadioGroup>
                            <div :class="prefixCls + '-item-info'">
                                <YYFileLogo :type="getType(item.fileName)"></YYFileLogo>
                                <span :class="prefixCls + '-item-filename'">{{item.fileName}}</span>
                                <span :class="prefixCls + '-item-filesize'">{{fileForm[index].size | bytesToSize}}</span>
                                <YYIcon type="close" @click.native="handleRemoveFile(item, index)"></YYIcon>
                            </div>
                            <YYCheckbox v-model="item.downloadEnable" v-if="!disabledDownload">允许下载</YYCheckbox>
                        </div>
                    </div>
                </div>
            </Upload>
        </div>
        <div :class="prefixCls + '-list'">
            <div 
                v-for="(item, index) in lastFileFormData"
                :class="prefixCls + '-item'" 
                :key="item.fileId">
                <YYRadioGroup v-model="item.security" v-if="!disabledSecurity">
                    <YYRadio 
                        v-for="(value, key) in fileSecurity" 
                        disabled
                        :key="key" 
                        :label="key">{{value.text}}</YYRadio>
                </YYRadioGroup>
                <div :class="prefixCls + '-item-info'">
                    <YYFileLogo :type="getType(item.fileName)"></YYFileLogo>
                    <span :class="prefixCls + '-item-filename'">{{item.fileName}}</span>
                    <span :class="prefixCls + '-item-filesize'">{{item.fileSize | bytesToSize}}</span>
                    <YYIcon type="close" @click.native="handleRemoveLastFile(item, index)"></YYIcon>
                </div>
                <YYCheckbox v-model="item.downloadEnable" disabled v-if="!disabledDownload">允许下载</YYCheckbox>
            </div>
        </div>
    </div>
</template>
<script>
    import { deepCopy, bytesToSize } from '../../../utils/assist'
    import axios from 'axios'
    import Upload from '../../base/upload/'
    import YYIcon from '../../base/icon/'
    import YYCheckbox from '../../base/checkbox/'
    import YYLoading from '../../base/loading/'
    import YYRadio from '../../base/radio/'
    import YYFileLogo from '../../base/file-logo/'
    import YYMessage from '../../base/message/'
    import Sortable from 'sortablejs'

    const prefixCls = 'yy-security-upload'
    export default {
        name: 'YYSecurityUpload',
        components: {
            Upload,
            YYIcon,
            YYCheckbox,
            YYRadio,
            YYRadioGroup: YYRadio.YYRadioGroup,
            YYFileLogo
        },
        props: {
            objectName: {
                type: String,
                required: true
            },
            showDrag: {
                type: Boolean,
                default: true
            },
            objectId: {
                type: String | Number,
                required: true
            },
            lastId: {
                type: String | Number
            },
            maxSize: {
                type: Number | String,
                default: 300 * 1024
            },
            security: {
                type: String
            },
            host: {
                type: String,
                default: 'http://ezone.imp.pub.caep'
                // default: '//ezone.pub-dev.caep'
            },
            disabledSecurity: {
                type: Boolean,
                default: false
            },
            disabledDownload: {
                type: Boolean,
                default: false
            }
        },
        data() {
            return {
                prefixCls,
                commonSecurity: { // 密级
                    PUBLIC: {
                        limit: 0,
                        text: '公开'
                    },
                    INTERNAL: {
                        limit: 1,
                        text: '内部'
                    },
                    SECRET: {
                        limit: 2,
                        text: '秘密'
                    },
                    CONFIDENTIAL: {
                        limit: 3,
                        text: '机密'
                    }
                },
                fileForm: [],
                fileFormData: [],
                lastFileFormData: [],
                deleteFileIds: []
            }
        },
        filters: {
            bytesToSize
        },
        computed: {
            fileSecurity() { // 计算附件密级
                let result = {}
                for(const key in this.commonSecurity) {
                    const data = this.commonSecurity[key]
                    if(!this.security || this.commonSecurity[this.security].limit >= data.limit) {
                        result[key] = data
                    }
                }
                // 监听附件密级
                if(this.security) {
                    this.fileFormData.forEach(item => {
                        if(this.commonSecurity[item.security] 
                        && (this.commonSecurity[this.security].limit < this.commonSecurity[item.security].limit)) {
                            item.security = ''
                        }
                    })
                }
                return result
            }
        },
        watch: {
            lastId: {
                immediate: true,
                handler: function () {
                   this.getLastFileFormData() 
                }
            }
        },
        methods: {
            getType(data) {
                if(typeof data != 'string') return ''
                return data.split('.').pop().toLocaleLowerCase() || ''
            },
            getLastFileFormData() {
                if(this.lastId) {
                    const action = `${this.host}/cooperation/rest/v1/file/security/${this.objectName}/${this.lastId}`
                       
                    axios.get(action, {
                        withCredentials: true
                    }).then(res => {
                        this.lastFileFormData = res.data && res.data.data || []
                    })
                }
            },
            getSize() { // 获取所有附件大小
                const files = this.getFiles()
                if(files.length <= 1) {
                    return files[0] ? files[0].fileSize : 0
                }
                return this.getFiles().reduce((a, b) => {
                    return (a.fileSize || a) + b.fileSize
                })
            },
            getMaxSecurity() { // 获取当前不可变更附件最高密级
                let security = 0
                this.lastFileFormData.forEach(item => {
                    const limit = this.commonSecurity[item.security].limit
                    if(limit > security) {
                        security = limit
                    }
                })
                return security
            },
            getFiles() { // 获取所有files
                const files = this.fileFormData.concat(this.lastFileFormData)
                return files
            },
            handleRemoveFile(item, key) { // 删除当前上传文件
                this.fileForm.splice(key, 1)
                this.fileFormData.splice(key, 1)
                this.$emit('on-file-remove', item)
            },
            handleRemoveLastFile(item, key) { // 删除曾经上传文件
                this.lastFileFormData.splice(key, 1)
                this.deleteFileIds.push(item.fileId)
                this.$emit('on-file-remove', item)
            },
            handleStartUpLoad() {
                return new Promise((resolve, reject) => {
                    // 没有附件时直接resolve
                    if(!this.fileFormData.length 
                    && !this.deleteFileIds.length 
                    && !this.lastFileFormData.length) return resolve(true)
                    
                    // 判断是否选择附件密级
                    let security = true
                    this.fileFormData.forEach((item) => {
                        if(this.disabledSecurity) {
                            item.security = 'PUBLIC'
                        }
                        if(this.disabledDownload) {
                            item.downloadEnable = true
                        }
                        if(!item.security) {
                            security = false
                        }
                    })
                    if(!security) {
                        YYMessage.warning('请选择附件密级')
                        return resolve(false)
                    }

                    let formData = new FormData()
                    this.fileForm.forEach((file) => {
                        formData.append('files', file)
                    })
                    formData.append('params', JSON.stringify(this.fileFormData))

                    // 更换当前已存在fileId的objectId映射
                    if(this.lastFileFormData.length) {
                        const fileIds = this.lastFileFormData.map(item => {
                            return item.fileId
                        })
                        formData.append('fileIds', JSON.stringify(fileIds))
                    }

                    // 更新已删除文件
                    if(this.deleteFileIds.length) {
                        formData.append('deleteFileIds', JSON.stringify(this.deleteFileIds))
                    }
                    
                    const action = `${this.host}/cooperation/rest/v1/file/security/${this.objectName}/${this.objectId}`
                    YYLoading.show({
                        text: '正在上传附件'
                    })
                    axios.post(action, formData, {
                        withCredentials: true
                    }).then(res => {
                        YYLoading.hide()
                        resolve(true)
                    }).catch(()=> {
                        YYLoading.hide()
                        YYMessage.error('附件上传失败')
                        resolve(false)
                    })
                })
            },
            sortable() {
                this.$nextTick().then(()=>{
                    const wrapper = this.$refs.sortableWrapper
                    const handle = `.sortable-item`
                    if(wrapper && handle) {
                        Sortable.create(wrapper, {
                            group: {
                                name: 'upload',
                                pull: false,
                                put: true
                            },
                            handle: handle,
                            onUpdate:  (evt) => {
                                this.handleDragUpdate(evt)
                            },
                            animation: 150
                        })
                    }
                })
            },
            removeNode(node) { // 移除节点
                node.parentElement.removeChild(node)
            },
            insertNodeAt(fatherNode, node, position) { // 插入节点
                let refNode = position === 0 ? fatherNode.children[0] : fatherNode.children[position - 1].nextSibling
                fatherNode.insertBefore(node, refNode)
            },
            handleDragUpdate(evt, data) { // 更新数据的时候
                this.removeNode(evt.item)
                this.insertNodeAt(evt.from, evt.item, evt.oldIndex)
                
                this.fileFormData.splice(evt.newIndex, 0, this.fileFormData.splice(evt.oldIndex, 1)[0])
                this.fileForm.splice(evt.newIndex, 0, this.fileForm.splice(evt.oldIndex, 1)[0])
            },
            beforeUpload (file) {
                if(file.size > this.maxSize * 1024) {
                    YYMessage.error('附件超过单附件大小限制')
                    return false
                }
                let key = -1
                this.fileFormData.forEach((item, index) => {
                    if(item.fileName === file.name) {
                        key = index
                    }
                })
                const param = {
                    fileSize: file.size,
                    fileName: file.name,
                    downloadEnable: false,
                    security: ''
                }
                if(key === -1) {
                    this.fileForm.push(file)
                    this.fileFormData.push(deepCopy(param))
                    this.sortable()
                } else {
                    this.fileForm.splice(key, 1, file)
                    this.fileFormData.splice(key, 1, deepCopy(param))
                }
                this.$emit('on-change', this.getFiles())
                return false
            }
        }
    }
</script>