<template>
    <div :class="prefixCls + '-list'">
        <div 
            v-for="item in data"
            :class="prefixCls + '-item'" 
            :key="item.fileId">
            <div :class="prefixCls + '-item-info'">
                <span :class="prefixCls + '-item-security'" v-if="!disabledSecurity">
                    密级：
                    <span :class="prefixCls + '-item-security-' + item.security">
                        {{security[item.security] && security[item.security].text || ''}}
                    </span>
                </span>
                <YYFileLogo :type="getType(item.fileName)"></YYFileLogo>
                <span :class="prefixCls + '-item-filename'">{{item.fileName}}</span>
                <span 
                    v-if="item.downloadEnable"
                    :class="prefixCls + '-item-download'" 
                    @click="handleDownload(item)">下载</span>
                <span 
                    :class="prefixCls + '-item-download'" 
                    @click="handlePreview(item)">预览</span>
                <span :class="prefixCls + '-item-filesize'">
                    {{item.fileSize | bytesToSize}}
                </span>
            </div>
        </div>
    </div>
</template>
<script>
    import axios from 'axios'
    import YYFileLogo from '../../base/file-logo/'
    import YYLoading from '../../base/loading/'
    import { bytesToSize } from '../../../utils/assist'
    
    const prefixCls = 'yy-security-upload'
    export default {
        name: 'YYSecurityUpload',
        components: {
            YYFileLogo
        },
        props: {
            objectName: {
                type: String,
                required: true
            },
            objectId: {
                type: String | Number,
                required: true
            },
            disabledSecurity: {
                type: Boolean,
                default: false
            },
            host: {
                type: String,
                // default: '//ezone.imp.pub.caep'
                default: 'http://ezone.pub-dev.caep'
            }
        },
        data() {
            return {
                prefixCls,
                data: [],
                security: { // 密级
                    PUBLIC: {
                        limit: 0,
                        text: '公开'
                    },
                    INTERNAL: {
                        limit: 1,
                        text: '内部'
                    },
                    SECRET: {
                        limit: 2,
                        text: '秘密'
                    },
                    CONFIDENTIAL: {
                        limit: 3,
                        text: '机密'
                    }
                }
            }
        },
        filters: {
            bytesToSize
        },
        methods: {
            getFiles() {
                return this.data
            },
            getType(data) {
                if(typeof data != 'string') return ''
                return data.split('.').pop().toLocaleLowerCase() || ''
            },
            getLastFileFormData() {
                const action = `${this.host}/cooperation/rest/v1/file/security/${this.objectName}/${this.objectId}`
                   
                axios.get(action, {
                    withCredentials: true
                }).then(res => {
                    this.data = res.data && res.data.data || []
                })
            },
            handleDownload(data) {
                const action = `${this.host}/cooperation/rest/v1/file/security/${data.fileId}/url/download`
                
                YYLoading.show()
                axios.get(action, {
                    withCredentials: true
                }).then(res => {
                    YYLoading.hide()
                    if(res.data && res.data.url) {
                        window.open(res.data.url, '_blank')
                    }
                }).catch((error) => {
                    YYLoading.hide()
                })
            },
            handlePreview(data) {
                const action = `${this.host}/cooperation/rest/v1/file/security/${data.fileId}/url/preview`
                YYLoading.show()
                axios.get(action, {
                    withCredentials: true
                }).then(res => {
                    YYLoading.hide()
                    if(res.data && res.data.url) {
                        window.open(res.data.url, '_blank')
                    }
                }).catch((error) => {
                    YYLoading.hide()
                })
            }
        },
        created() {
            this.getLastFileFormData()
        }
    }
</script>