<template>
    <div :class="prefixCls">
        <div :class="`${prefixCls}-fixed`" ref="scrollContent">
            <div v-if='insearch' :class="`${prefixCls}-tab ${prefixCls}-tab-active`">
                {{t('selectMember.search')}}
            </div>
            <template v-else>
                <div v-for="(tab, key) in tabs" :key="key"
                    :class="[
                        `${prefixCls}-tab`,
                        {
                            [`${prefixCls}-tab-active`]: tab === activeTab
                        }
                    ]"
                    @click="handleSwitchTab(tab)">
                    {{tabsPane[tab]}}
                </div>
                <div v-for="(tab) in customTabs" 
                    :key="tab.key"
                    :class="[
                        `${prefixCls}-tab`,
                        {
                            [`${prefixCls}-tab-active`]: tab.key === activeTab
                        }
                    ]"
                    @click="handleSwitchTab(tab.key)">
                    {{tab.title}}
                </div>
            </template>
        </div>
        <div :class="`${prefixCls}-body`" :style="{
            height: root.position && (parseInt(root.position.height)  - 152 + 'px')
        }" v-show="insearch">
            <Search 
                @handleSelected="handleSelected" />
        </div>
        <div :class="`${prefixCls}-body`" :style="{
            height: root.position && (parseInt(root.position.height)  - 152 + 'px')
        }" v-show="!insearch">
            <keep-alive>
                <SectionDept 
                    v-if="activeTab === 'dept'"
                    :withMembers="false"
                    @handleSelected="handleSelected" />
            </keep-alive>
            <keep-alive>
                <SectionDept 
                    v-if="activeTab === 'deptMember'"
                    :withMembers="true" 
                    @handleSelected="handleSelected" />
            </keep-alive>
            <keep-alive>
                <SectionGroup 
                    v-if="activeTab === 'group'"
                    :withMembers="false" 
                    @handleSelected="handleSelected"/>
            </keep-alive>
            <keep-alive>
                <SectionGroup 
                    v-if="activeTab === 'groupMember'"
                    :withMembers="true" 
                    @handleSelected="handleSelected"/>
            </keep-alive>
            <keep-alive>
                <SectionTeam 
                    v-if="activeTab === 'team'"
                    :withMembers="false" 
                    @handleSelected="handleSelected" />
            </keep-alive>
            <keep-alive>
                <SectionTeam 
                    v-if="activeTab === 'teamMember'"
                    :withMembers="true"
                    @handleSelected="handleSelected" />
            </keep-alive>
            <keep-alive>
                <SectionMember 
                    v-if="activeTab === 'member'"
                    @handleSelected="handleSelected"/>
            </keep-alive>
            <keep-alive 
                v-for="tab in customTabs" 
                :key="tab.key">
                <SectionCustomMember
                    v-if="activeTab === tab.key && tab.type === 'member'"
                    :data="tab.data || []"
                    :onLoad="tab.onLoad"
                    @handleSelected="handleSelected"/>
                <SectionCustomDept
                    v-if="activeTab === tab.key && tab.type === 'dept'"
                    :data="tab.data || []"
                    :withMembers="!!tab.withMembers"
                    :onLoad="tab.onLoad"
                    @handleSelected="handleSelected"/>
                <SectionCustomList
                    v-if="activeTab === tab.key && tab.type === 'list'"
                    :data="tab.data || []"
                    :onLoad="tab.onLoad"
                    @handleSelected="handleSelected"/>
            </keep-alive>
        </div>
    </div>
</template>
<script>
    import SectionDept from './section/section-dept'
    import SectionGroup from './section/section-group'
    import SectionTeam from './section/section-team'
    import SectionMember from './section/section-member'
    import SectionExternal from './section/section-external'
    import SectionCustomMember from './section/section-custom-member'
    import SectionCustomDept from './section/section-custom-dept'
    import SectionCustomList from './section/section-custom-list'
    import Search from './search'
    import PerfectScrollbar from 'perfect-scrollbar'
    import Locale from '../../../mixins/locale'

    const prefixCls = 'yy-select-member-section'
    export default {
        name: 'YYSection',
        mixins: [Locale],
        inject: ['root'],
        components: {
            SectionDept,
            SectionGroup,
            SectionTeam,
            SectionMember,
            SectionExternal,
            SectionCustomMember,
            SectionCustomDept,
            SectionCustomList,
            Search
        },
        props: ['tabs', 'selected', 'insearch', 'customTabs', 'defaultActiveTab'],
        data() {
            return {
                prefixCls: prefixCls,
                activeTab: this.tabs[0],
                tabsPane: {
                    dept: this.t('selectMember.dept'),
                    deptMember: this.t('selectMember.deptMember'),
                    group: this.t('selectMember.group'),
                    groupMember: this.t('selectMember.groupMember'),
                    team: this.t('selectMember.team'),
                    teamMember: this.t('selectMember.teamMember'),
                    member: this.t('selectMember.member'),
                    external: this.t('selectMember.external')
                },
                scroll: null,
                container: null
            }
        },
        methods: {
            handleSwitchTab(tab) {
                this.activeTab = tab
            },
            handleSelected(data) {
                this.$emit('handleSelected', data)
            },
            setVerticalScroll() {
                this.container = this.$refs.scrollContent
                this.scroll = new PerfectScrollbar(this.container, {
                    wheelSpeed: 0.5,
                    wheelPropagation: false,
                    useBothWheelAxes: true,
                    minScrollbarLength: 60,
                    maxScrollbarLength: 300,
                    useBothWheelAxes: true
                })
            },
            setCustomData() {
                if(this.defaultActiveTab) {
                    this.handleSwitchTab(this.defaultActiveTab)
                }
                if(this.customTabs) { // 自定义页签初始数据初始化
                    this.customTabs.forEach(tab => {
                        tab.data && tab.data.forEach(item => {
                            item.checked = item.checked || false
                            item.type = item.type || 0
                            
                            if(tab.type != 'list' && !item.memberId && (item.deptName || item.deptId)) {
                                item.children = []
                                item.expand = !!item.expand
                                item.loading = false
                                item.haveSub = !!item.haveSub || true
                                item.userNum = 10
                                item.type = item.type || 1
                            }
                            
                            if(tab.type === 'list') {
                                item.type === 5
                            }

                            if(item.checked) {
                                this.handleSelected(item)
                            }
                        })
                    })
                }
            }
        },
        created () {
            this.setCustomData()  
        },
        mounted() {
            this.setVerticalScroll()
        }
    }
</script>

