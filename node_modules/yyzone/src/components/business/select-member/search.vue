<template>
    <div class="yy-select-member-search scroll-content-horizonal" ref="scrollContent">
        <Scroller>
            <Collapse v-if="member.length">
                <template slot="title">
                    {{t('selectMember.member')}}
                </template>
                <template slot="content">
                    <MemberNode 
                        v-for="(item, index) in member"
                        :key="index"
                        :data="item"
                        @handleChecked="handleChecked" />
                </template>
            </Collapse>
            <Collapse v-if="dept.length">
                <template slot="title">
                    {{t('selectMember.dept')}}
                </template>
                <template slot="content">
                    <DeptNode 
                        v-for="(item, index) in dept"
                        :key="index"
                        :data="item"
                        :withMembers="false"
                        :showExpand="false"
                        @handleChecked="handleChecked" />
                </template>
            </Collapse>
            <Collapse v-if="group.length">
                <template slot="title">
                    {{t('selectMember.group')}}
                </template>
                <template slot="content">
                    <GroupNode 
                        v-for="(item, index) in group"
                        :data="item"
                        :key="index"
                        :withMembers="false"
                        @handleChecked="handleChecked"/>
                </template>
            </Collapse>
            <Collapse v-if="team.length">
                <template slot="title">
                    {{t('selectMember.team')}}
                </template>
                <template slot="content">
                    <TeamNode 
                        v-for="(item, index) in group"
                        :data="item"
                        :key="index"
                        :withMembers="false"
                        @handleChecked="handleChecked"/>
                </template>
            </Collapse>
            <Loading v-model="loading"/>
            <!-- <Load 
                :hasData="hasData"
                :hasMore="hasMore"
                :loading="loading" 
                @on-load="getMemberList"/> -->
            <Empty type="search" 
                v-if="isEmpty"/>
        </Scroller>
    </div>
</template>
<script>
    import Emitter from '../../../mixins/emitter'

    import DeptNode from './section/section-dept-node'
    import GroupNode from './section/section-group-node'
    import TeamNode from './section/section-team-node'
    import MemberNode from './section/section-member-node'
    import Collapse from '../../base/collapse'
    import Empty from '../../base/empty/'
    import Load from '../../base/page/'
    import Scroller from '../../base/scroller/'
    import Locale from '../../../mixins/locale'
    import axios from 'axios'
    import Loading from '../../base/loading/'
    export default {
        name: 'YYSearch',
        mixins: [Locale, Emitter],
        components: {
            DeptNode,
            GroupNode,
            TeamNode,
            MemberNode,
            Collapse,
            Empty,
            Load,
            Scroller,
            Loading
        },
        inject: ['root'],
        data() {
            return {
                member: [],
                dept: [],
                group: [],
                team: [],
                loading: false,
                hasMore: true
            }
        },
        computed: {
            hasData() {
                return !!(this.member.length || this.dept.length || this.group.length || this.team.length)
            },
            isEmpty() {
                return !this.loading && !this.hasMore && !this.hasData
            }
        },
        methods: {
            getMemberList(resolve) {
                const { host, qzId, keyword, chooseDeptType, language, security, deptList = [] } = this.root
                console.log(deptList)
                const deptIds = deptList && deptList.map((item)=>{
                    return item.deptId
                }) || null
                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/members`, {
                    params: {
                        page: 1,
                        size: 10,
                        keyword: keyword || '',
                        deptIds: deptIds && deptIds.join(','),
                        type: chooseDeptType,
                        language: language,
                        security: security
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        resolve({ member: [] })
                    }
                    data.forEach(item => {
                        item.checked = false
                    })
                    resolve({ member: data })
                }).catch(error => {
                    resolve({ member: [] })
                })
            },
            getDeptList(resolve) {
                const { host, qzId, keyword, language } = this.root

                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/0/depts`, {
                    params: {
                        withMembers: 0,
                        keyword: keyword,
                        language: language
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        resolve({ dept: [] })
                    }
                    data.forEach(item => {
                        item.checked = false
                        item.haveSub = 0
                        item.userNum = 0
                    })
                    resolve({ dept: data })
                }).catch(error => {
                    resolve({ dept: [] })
                })
            },
            getGroupList(resolve) {
                const { host, qzId, keyword, language } = this.root
                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/groups`, {
                    params: {
                        keyword: keyword,
                        page: 1,
                        size: 10,
                        language: language
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        resolve({ group: [] })
                    }
                    data.forEach(item => {
                        item.checked = false
                    })
                    resolve({ group: data })
                }).catch(error => {
                    resolve({ group: [] })
                })
            },
            getTeamList(resolve) {
                const { host, qzId, keyword, language } = this.root

                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/team/list`, {
                    params: {
                        keyword: keyword,
                        page: 1,
                        size: 10,
                        language: language
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        resolve({ team: [] })
                    }
                    data.forEach(item => {
                        item.type = 4
                        item.checked = false
                    })
                    resolve({ team: data })
                }).catch(error => {
                    resolve({ team: [] })
                })
            },
            handleChecked(checked, data) {
                data.checked = checked
                this.$emit('handleSelected', data)
            },
            initSearch() {
                const tabs = this.root.tabs
                this.root.handleSearch = () => {
                    const searchTabs = ['deptMember', 'member', 'groupMember', 'teamMember']
                    // if(searchTabs.indexOf(this.$parent.activeTab) === -1) {
                    //     return this.dispatch('YYSelectMember', 'on-search', this.root.keyword)
                    // }
                    this.member = []
                    this.dept = []
                    this.group = []
                    this.team = []
                    if(!this.root.keyword.trim()) {
                        return this.root.insearch = false
                    }
                    // this.updateScroll()
                    this.loading = true
                    this.hasMore = true
                    const tabsFun = [
                        {
                            key: 'member',
                            fun: ()=>{
                                return new Promise(resolve=>{
                                    this.getMemberList(resolve)
                                })
                            }
                        },
                        {
                            key: 'dept',
                            fun: ()=>{
                                return new Promise(resolve=>{
                                    this.getDeptList(resolve)
                                })
                            }
                        },
                        {
                            key: 'group',
                            fun: ()=>{
                                return new Promise(resolve=>{
                                    this.getGroupList(resolve)
                                })
                            }
                        },
                        {
                            key: 'team',
                            fun: ()=>{
                                return new Promise(resolve=>{
                                    this.getTeamList(resolve)
                                })
                            }
                        }
                    ]
                    const searchFun = tabsFun.filter((item)=>{
                        if(item.key === 'member') {
                            return JSON.stringify(tabs).toLocaleLowerCase().indexOf(item.key) != -1
                        }
                        return tabs.indexOf(item.key) != -1
                    }).map(item=>{ return item.fun() })
                    this.root.insearch = true
                    Promise.all(searchFun).then((res)=>{
                        res.forEach(item=>{
                            const key = Object.keys(item)[0]
                            this[key] = item[key]
                        })
                        this.loading = false
                        this.hasMore = false
                    })
                }
            }
        },
        created() {
            this.initSearch()
        }
    }
</script>
