<template>
    <Scroller>    
        <DeptNode 
            v-for="(item, index) in list"
            @handleExpand="handleExpand"
            @handleChecked="handleChecked"
            @getDeptChildList="getDeptChildList"
            :data="item"
            :key="index"
            :withMembers="withMembers" />
        <Load 
            v-if="!root.deptList"
            :hasData="!!list.length"
            :hasMore="hasMore"
            :loading="loading" 
            @on-load="getDeptList"/>
        <Empty v-if="!loading && !hasMore && !list.length"/>
    </Scroller>
</template>
<script>
    /**
     * 组织
     *  */
    import DeptNode from './section-dept-node'
    import Section from '../mixins/section'
    import Empty from '../../../base/empty/'
    import Message from '../../../base/message/'
    import { t } from '../../../../locale/'
    import axios from 'axios'

    export default {
        name: 'YYSectionDept',
        mixins: [Section],
        components: {
            DeptNode,
            Empty
        },
        inject: ['root'],
        props: {
            withMembers: {
                type: Boolean,
                default: false
            }
        },
        methods: {
            getDeptList(deptId, params, checked, isFirst) { // 拉取当前组织树
                this.loading = true
                params && (params.loading = true)
                const { host, qzId, chooseDeptType, chooseDeptMemberType, language, security } = this.root
                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/${deptId || 0}/depts`, {
                    params: {
                        withMembers: 1 - !(deptId && this.withMembers),
                        size: 9999,
                        type: chooseDeptType,
                        language: language,
                        security: security
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        return this.handleError(params || null)
                    }
                    let members = []
                    data.forEach(item => {
                        item.expand = false
                        item.checked = false
                        item.contain = false
                        item.children = []
                        item.loading = false
                        if(this.withMembers) {
                            item.indeterminate = false
                        }
                        // 当存在父级， 并且为人员，只选择一级下面的人
                        if(params && item.type === 0 && chooseDeptMemberType == 1) {
                            if(checked) {
                                item.parent = params
                                item.checked = checked
                                this.$emit('handleSelected', item)
                            }
                            members.push(item)
                        }
                    })

                    if(params && chooseDeptMemberType == 1 && this.withMembers) {
                        params.members = members
                    }
                    this.loading = false
                    this.hasMore = false

                    if(isFirst) {
                        return this.list = this.list.concat(data)
                    }
                    params && (params.children = data)
                    params && (params.loading = false)
                }).catch(error => {
                    this.handleError(params)
                })
            },
            getMyDept() { // 获取我的部门
                const { host, qzId, language } = this.root
                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/dept`, {
                    params: {
                        withMembers: 1 - !this.withMembers,
                        language: language
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    data.deptName = "我的部门"
                    if(!Array.isArray(data)) return
                    data.forEach(item => {
                        item.deptName = item.deptName + "（本部门）"

                        item.userNum = 1
                        item.expand = false
                        item.checked = false
                        item.contain = false
                        item.loading = false
                        item.children = []
                        if(this.withMembers) {
                            item.indeterminate = false
                        }
                    })
                    if(data.length) this.list.unshift(data[0])
                })
            },
            getDeptChildList(deptId, params, checked) { // 包含下级接口
                params.contain = !params.contain
                params.checked = params.contain
                this.$emit('handleSelected', params)
                if(params.data) {
                    return params.data.forEach(item => {
                        item.checked = params.contain
                        this.$emit('handleSelected', item)
                    })
                }
                params.loading = true
                const { host, qzId, language } = this.root
                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/${deptId}/sub_depts`, {
                    params: {
                        language: language
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        return this.handleError(params)
                    }
                    data.forEach(item => {
                        item.checked = params.contain
                        this.$emit('handleSelected', item)
                    })
                    params.loading = false
                    params.data = data
                }).catch(error => {
                    this.handleError(params)
                })
            },
            getDeptMemberList(deptId, params, checked) { // 拉取当前组织下人员
                params.loading = true
                const { host, qzId, chooseDeptType, language, security } = this.root

                axios.get(`${host}/cooperation/rest/v1/candidate/${qzId}/members`, {
                    params: {
                        deptIds: deptId,
                        size: 9999,
                        type: chooseDeptType,
                        language: language,
                        security: security
                    },
                    withCredentials: true
                }).then(res => {
                    let data = res.data
                    if(!Array.isArray(data)) {
                        return params.loading = false
                    }
                    data.forEach(item => {
                        item.parent = params
                        item.checked = !!checked
                        this.$emit('handleSelected', item)
                    })
                    params.members = data
                    params.loading = false
                }).catch(error => {
                    params.loading = false
                })
            },
            handleExpand(expand, data) {
                data.expand = expand
                if(data.children && data.children.length) return
                this.getDeptList(data.deptId, data)
            },
            handleChecked(checked, data) {
                if(data.loading) return
                if(!this.withMembers || data.type === 0) { // 如果只选择组织或者单选人员
                    if(checked && 1 + this.root.selectedCount > this.root.limit && this.root.limit != 1) {
                        return Message.warning(t('selectMember.maximum'))
                    }
                    data.checked = checked
                    return this.$emit('handleSelected', data)
                }
                if(checked && data.userNum + this.root.selectedCount > this.root.limit) {
                    return Message.warning(t('selectMember.maximum'))
                }
                // 按照部门选择人员的时候
                data.indeterminate = checked
                if(data.members && data.members.length) {
                    return data.members.forEach(item => {
                        item.checked = !!checked
                        this.$emit('handleSelected', item)
                    })
                } 
                if(this.root.chooseDeptMemberType == 1) {
                    this.getDeptList(data.deptId, data, checked)
                } else {
                    this.getDeptMemberList(data.deptId, data, checked)
                }
            },
            init() {
                if(this.root.deptList && this.root.deptList.length) { // 如果传根组织列表了 一级为当前传入的组织
                    return this.list = this.root.deptList.map((item)=>{
                        return {
                            ...item,
                            loading: false,
                            checked: false,
                            expand: false,
                            indeterminate: false,
                            type: 1,
                            haveSub: 1,
                            userNum: 1,
                            children: []
                        }
                    })
                }
                if(this.root.chooseDeptType != 2) {
                    this.getMyDept()
                }
                this.getDeptList(null, null, null, true)
            }
        },
        created() {
            this.init()
        }
    }
</script>
