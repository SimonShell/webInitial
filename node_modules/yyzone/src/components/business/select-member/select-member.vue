<template>
    <transition name="fade">
        <div 
            ref="selectWrapper" 
            v-transfer-dom 
            :data-transfer="transfer" 
            :class="prefixCls" 
            :style="{'z-index': transferIndex}"
            v-show="value">
            <transition name="move-up">
                <div ref="selectFrame"
                    v-show="value"
                    :class="`${prefixCls}-wrapper`" 
                    :style="position">
                    <div :class="`${prefixCls}-header`">
                        <div ref="dragBar" :class="`${prefixCls}-header-title`">
                            {{title || (selectType === 'member' ? t('selectMember.title') : t('selectMember.titleRange'))}}
                        </div>
                        <div :class="`${prefixCls}-header-search`">
                            <input
                                ref="searchInput"
                                :class="searchClasses"
                                v-model="keyword" 
                                type="text" 
                                @keydown.enter="handleSearch">
                            <span @click="handleFocus" 
                                :class="`${prefixCls}-header-search-icon`">
                                <Icon size="14px" type="search"/>
                            </span>
                        </div>
                        <span v-if="closeable" 
                            :class="`${prefixCls}-header-close`" 
                            @click="handleCancel">
                            <Icon size="14px" type="close"/>
                        </span>
                    </div>
                    <div :class="`${prefixCls}-body`">
                        <Section 
                            v-if="value"
                            ref="section"
                            :tabs="tabs"
                            :customTabs="customTabs"
                            :defaultActiveTab="defaultActiveTab"
                            :insearch="insearch"
                            @handleSelected="handleSelected" />
                        <Selected 
                            @handleSelected="handleSelected" 
                            :selected="selected"
                            :limit="limit" />
                    </div>
                    <div :class="`${prefixCls}-footer`">
                        <p :class="`${prefixCls}-footer-warning`">
                            <span v-if="selectedCount >= limit">
                                <span v-if="language === 'zhs'">最多选择{{this.limit}}条数据</span>
                                <span v-if="language === 'zht'">最多選擇{{this.limit}}條數據</span>
                                <span v-if="language === 'en'">Select up to {{this.limit}} data</span>
                            </span>
                        </p>
                        <div>
                            <YYButton type="default" @click="handleCancel">
                                {{t('selectMember.cancel')}}
                            </YYButton>
                            <YYButton :loading="loading" type="primary" :style="{ marginLeft: '4px' }" @click="handleOk">
                                {{t('selectMember.ok')}}
                            </YYButton>
                        </div>
                    </div>
                    <div v-if="enableResize" ref="resizeBar" class="resize-bar resize-br"></div>
                </div>
            </transition>
        </div>
    </transition>
</template>
<script>
    import Selected from './selected'
    import Section from './section'
    import YYButton from '../../base/button/'
    import Icon from '../../base/icon/'
    import Locale from '../../../mixins/locale'
    import { on, off } from '../../../utils/dom'
    import { oneOf, deepCopy } from '../../../utils/assist'
    import { transferIndex, transferIncrease } from '../../../utils/transfer-queue'
    import { getLang } from '../../../locale/'
    import TransferDom from '../../../directives/transfer-dom'
    import ScrollbarMixins from '../../../mixins/scrollbar'
    import Keydown from '../../../mixins/keydown'

    const prefixCls = 'yy-select-member'
    const host = `${window.location.protocol}//${window.location.host}`
    const types = {
        0: {
            key: 'member',
            id: 'memberId',
            yhtUserId: 'yhtUserId'
        },
        1: {
            key: 'dept',
            id: 'deptId'
        },
        3: {
            key: 'group',
            id: 'gid'
        },
        4: {
            key: 'team',
            id: 'id'
        },
        5: {
            key: 'list',
            id: 'id'
        }
    }
    export default {
        name: 'YYSelectMember',
        mixins: [Locale, ScrollbarMixins, Keydown],
        components: {
            Selected,
            Section,
            YYButton,
            Icon
        },
        directives: {
            TransferDom
        },
        provide() {
            return {
                root: this
            }
        },
        props: {
            value: {
                type: Boolean,
                default: true
            },
            transfer: {
                type: Boolean,
                default: true
            },
            closeable: {
                type: Boolean,
                default: true
            },
            qzId: {
                type: [String, Number],
                required: true
            },
            /**
             * 根组织列表 
             * [{deptId: 0, deptName: '用友网络科技股份有限公司'}]
             */
            deptList: { 
                type: Array
            },
            /** 
             * 选择组织类型 
             * 0全部 
             * 1仅部门
             * 2仅组织 
             * */
            chooseDeptType: { 
                validator: function(value) {
                    return oneOf(value, [0, 1, 2, '0', '1', '2'])
                },
                default: 0
            },
            /** 
             * 选择组织下人员类型 
             * 0当前组织下全部人员
             * 1只属于当前组织人员
             * */
            chooseDeptMemberType: { 
                validator: function(value) {
                    return oneOf(value, [0, 1, '0', '1'])
                },
                default: 0
            },
            /**
             * ckaoke: http://ezone.yyuap.com:6058/
             * daily: https://ezone-daily.yyuap.com/
             * u8c-daily: https://ezone-u8c-daily.yyuap.com/
             * 预发布: https://ezone.esn.ren/
             * 线上:   https://ezone.yonyoucloud.com/
             */
            host: { // 接口地址 支持自定义 
                type: String,
                default: host
            },
            title: { // 标题
                type: String
            },
            limit: { // 人数限制
                type: Number,
                default: 1500
            },
            isUseYhtUserId: { // 是否使用友互通id
                type: Boolean,
                default: false
            },
            enableContainChild: { // 是否允许包含下级
                type: Boolean,
                default: false
            },
            enableCatche: { // 是否允许缓存
                type: Boolean,
                default: false
            },
            catchName: { // 缓存名称
                type: String,
                default: 'YYSelectMemberData'
            },
            enableDrag: { // 是否允许拖拽
                type: Boolean,
                default: true
            },
            enableResize: { // 是否允许改变窗口大小
                type: Boolean,
                default: true
            },
            selectType: {
                validator: function(value) {
                    return oneOf(value, ['member', 'range'])
                },
                default: 'member'
            },
            enableDeptIds: { // 允许选择的deptId集合
                type: Array
            },
            defineTabs: { // 自定义已存在页签
                type: Array
            },
            // customTabs 数据格式
            // [
            //     {
            //         title: '单据相关人员',
            //         key: 'defineMembers',
            //         type: 'member',
            //         onLoad: (callback) => { },
            //         hasMore: false,
            //         data: [
            //             {
            //                 memberId: 123,
            //                 userName: 'nizhja',
            //                 type: 0,
            //                 checked: true
            //             }
            //         ]
            //     },
            //     {
            //         title: '单据相关组织',
            //         key: 'defineDepts',
            //         type: 'dept',
            //         onLoad: (callback) => { },
            //         hasMore: false,
            //         data: [
            //             {
            //                 deptId: 123,
            //                 deptName: 'nizhja',
            //                 haveSub: true,
            //                 expand: false,
            //                 type: 1,
            //                 checked: true
            //             }
            //         ]
            //     },
            // ]
            customTabs: { // 自定义页签扩展
                type: Array
            },
            defaultActiveTab: { // 默认激活页签
                type: String
            },
            haveSelected: { // 回显数据 当开启缓存回显时失效
                type: Object,
                default: function() {
                    return {
                        member: {},
                        dept: {},
                        group: {},
                        team: {},
                        list: {}
                    }
                }
            },
            security: {
                type: Boolean,
                default: false
            },
            sortable: { // 是否需要排序如果需要排序，返回的字段和回显的字段需要在id之前加一个m
                type: Boolean,
                default: false
            }
        },
        data() {
            return {
                prefixCls: prefixCls,
                selected: {
                    member: {},
                    dept: {},
                    group: {},
                    team: {},
                    list: {}
                },
                position: null,
                keyword: '',
                language: getLang(),
                isFocus: false,
                insearch: false,
                selectedCount: 0,
                transferIndex: 0,
                loading: false
            }
        },
        computed: {
            searchClasses() {
                return [
                    `${prefixCls}-header-search-input`,
                    {
                        [`${prefixCls}-header-search-input-focused`]: this.isFocus
                    }
                ]
            },
            tabs() {
                if(this.defineTabs) return this.defineTabs
                if(this.selectType === 'member') return [
                    'deptMember',
                    'member',
                    'groupMember',
                    'teamMember',
                ]
                return [
                    'dept',
                    'member',
                    'group',
                    'team',
                ]
            }
        },
        watch: {
            value: function(newValue) { // 监听是否打开组件
                if (newValue) {
                    this.loading = false
                    this.handleGetIndex()
                    this.addScrollEffect()
                    on(window, 'keydown', this.handleKeydown)
                    this.$nextTick(() => {
                        this.init()
                    })
                } else {
                    off(window, 'keydown', this.handleKeydown)
                    this.removeScrollEffect()
                }
                if (this.enableCatche && !newValue) {
                    return localStorage.setItem(this.catchName, JSON.stringify(this.selected))
                }
                const selected = this.setSelectedType()
                if (this.enableCatche) { // 允许缓存直接从缓存拿
                    const catchSelected = JSON.parse(localStorage.getItem(this.catchName))
                    this.$set(this, 'selected', {
                        ...this.selected,
                        ...catchSelected || deepCopy(selected)
                    })
                } else {
                    this.$set(this, 'selected', {
                        ...this.selected,
                        ...deepCopy(selected)
                    })
                }
                this.insearch = false 
                this.isFocus = false
                this.keyword = ''
                this.setSelectedCount()
            }
        },
        methods: {
            setSelectedType() { // 设置已选type类型
                let selected = deepCopy(this.haveSelected)
                let newSelected = {
                    member: {},
                    dept: {},
                    group: {},
                    team: {},
                    list: {}
                }
                const types = {
                    member: 0,
                    dept: 1,
                    group: 3,
                    team: 4,
                    list: 5
                }
                for(let k in selected) {
                    for(let j in selected[k]) {
                        if(this.sortable) {
                            newSelected[k][j] = selected[k][j]
                            newSelected[k][j].type = types[k]
                        } else {
                            newSelected[k]['m' + j] = selected[k][j]
                            newSelected[k]['m' + j].type = types[k]
                        }
                    }
                }
                return newSelected
            },
            setSelectedCount() { // 设置当前已选数量
                const selected = this.selected
                let count = 0
                Object.keys(selected).forEach((key)=>{
                    count += Object.keys(selected[key]).length
                })
                this.selectedCount = count
                return count
            },
            handleRadioSelected(data) { // 提供单选
                this.selected = {
                    member: {},
                    dept: {},
                    group: {},
                    team: {},
                    list: {}
                }
                const key = types[data.type].key
                const id = 'm' + data[types[data.type].id]
                if(data.checked) {
                    this.$set(this.selected[key], id, data)
                    this.setSelectedCount()
                }
            },
            handleSelected(data) {
                if(data.checked && this.selectedCount === 1 && this.limit == 1 ) {
                    return this.handleRadioSelected(data)
                }
                if(data.checked && this.selectedCount >= this.limit) return
                const key = types[data.type].key
                const id = 'm' + data[types[data.type][data.type == '0' && this.isUseYhtUserId ? 'yhtUserId' : 'id']]
                
                if(data.checked) {
                    this.$set(this.selected[key], id, data)
                    this.setSelectedCount()
                    return
                }

                let param = this.selected[key][id]
                if(param && param.type === 0 && param.parent && !data.checked) {
                    param.parent.indeterminate = false
                }
                this.$set(this.selected[key], id, null)
                delete this.selected[key][id]
                this.setSelectedCount()
            },
            handleClear() {
                this.selectedCount = 0
                Object.keys(this.selected.member).forEach((key)=>{
                    let member = this.selected.member[key]
                    if(member.parent) {
                        member.parent.indeterminate = false
                    }
                })
                this.$set(this, 'selected', {
                    member: {},
                    dept: {},
                    group: {},
                    team: {},
                    list: {}
                })
            },
            handleFocus() {
                this.isFocus = !this.isFocus
                if(this.isFocus) this.$refs.searchInput.focus()
                if(!this.isFocus) {
                    this.insearch = false 
                    this.keyword = ''
                    const searchTabs = ['deptMember', 'member', 'groupMember', 'teamMember']
                    if(searchTabs.indexOf(this.$refs.section.activeTab) === -1) {
                        return this.$emit('on-search', this.keyword)
                    }
                }
            },
            handleSearch() {
                this.insearch = true
            },
            handleCancel() {
                this.$emit('input', false)
            },
            deepCopy(source) { // 只拷贝一层
                const targetObj = source.constructor === Array ? [] : {}
                for (let keys in source) { 
                    if (source.hasOwnProperty(keys)) {
                        if (!(source[keys] && typeof source[keys] === 'object')) {
                            targetObj[keys] = source[keys]
                        }
                    }
                }
                return targetObj;
            },
            handleOk() { // 点击确定
                this.loading = true
                let responseSelected = {
                    dept: {},
                    group: {},
                    team: {},
                    member: {},
                    list: {}
                }
                for (let i in this.selected) {
                    for (let j in this.selected[i]) {
                        if(this.sortable) {
                            responseSelected[i][j] = this.deepCopy(this.selected[i][j])
                        } else {
                            responseSelected[i][j.replace('m', '')] = this.deepCopy(this.selected[i][j])
                        }
                    }
                }
                setTimeout(()=>{
                    this.$emit('input', false)
                    this.$emit('on-ok', responseSelected)
                }, 200)
            },
            setFramePosition(position) { // 设置当前窗体位置
                if(position.left || position.top) {
                    this.position['marginLeft'] = 0
                    this.position['marginTop'] = 0
                }
                this.position = {
                    ...this.position,
                    ...position
                }
            },
            initDrag() { // 初始化拖拽移动窗口
                if(!this.enableDrag) return
                const frame = this.$refs.selectFrame
                const handle = this.$refs.dragBar
                const docElement = document.documentElement
                const _this = this
                handle.onmousedown = function(event) {
                    let dEvent = event || window.event
                    let disX = dEvent.clientX - frame.offsetLeft
                    let disY = dEvent.clientY - frame.offsetTop

                    document.onmousemove = function(event) {
                        let mEvent = event || window.event
                        let iL = mEvent.clientX - disX
                        let iT = mEvent.clientY - disY
                        let maxL = docElement.clientWidth - frame.offsetWidth
                        let maxT = docElement.clientHeight - frame.offsetHeight
                        iL <= 0 && (iL = 0)
                        iT <= 0 && (iT = 0)
                        iL >= maxL && (iL = maxL)
                        iT >= maxT && (iT = maxT)
                
                        _this.setFramePosition({
                            left: iL + "px",
                            top: iT + "px",
                        })
                        return false
                    }

                    document.onmouseup = function() {
                        document.onmousemove = null;
                        document.onmouseup = null;
                    }
                    return false
                }
            },
            initResize() { // 初始化拖拽改变窗口大小
                if(!this.enableResize) return
                const frame = this.$refs.selectFrame
                const resizeBar = this.$refs.resizeBar
                const _this = this
                let position = {
                    ...this.position
                }
                function resize(frame, handle, isLeft, isTop, lockX, lockY) {
                    handle.onmousedown = function(event) {
                        let dEvent = event || window.event
                        let disX = dEvent.clientX - handle.offsetLeft
                        let disY = dEvent.clientY - handle.offsetTop

                        let iParentTop = frame.offsetTop
                        let iParentLeft = frame.offsetLeft
                        let iParentWidth = frame.offsetWidth
                        let iParentHeight = frame.offsetHeight
                        let lastHeight = 0;

                        document.onmousemove = function(event) {
                            let mEvent = event || window.event
                            let iL = mEvent.clientX - disX
                            let iT = mEvent.clientY - disY

                            let maxW = document.documentElement.clientWidth - frame.offsetLeft - 2
                            let maxH = document.documentElement.clientHeight - frame.offsetTop - 2;
                            let maxL = document.documentElement.clientWidth - parseInt(position.width) - 2
                            let maxT = document.documentElement.clientHeight - parseInt(position.height) - 2

                            let iW = isLeft ? iParentWidth - iL : handle.offsetWidth + iL
                            mEvent.clientY > 0 && (lastHeight = iParentHeight - iT)
                            let iH = isTop ? (mEvent.clientY <= 0 ? lastHeight : iParentHeight - iT) : handle.offsetHeight + iT
                            isLeft && (position.left = Math.min((iParentLeft + iL), maxL) + "px")
                            isTop && (position.top = Math.max(Math.min((iParentTop + iT), maxT), 0) + "px")

                            iW < parseInt(position.minWidth) && (iW = parseInt(position.minWidth))
                            iW > maxW && (iW = maxW)
                            lockX || (position.width = iW + "px")
                            iH < parseInt(position.minHeight) && (iH = parseInt(position.minHeight))
                            iH > maxH && (iH = maxH)
                            lockY || (position.height = iH + "px")
                            if((isLeft && iW == parseInt(position.minWidth)) || (isTop && iH == parseInt(position.minHeight))) {
                                document.onmousemove = null
                            }
                           
                            _this.setFramePosition({
                                width: position.width,
                                height: position.height
                            })
                            return false
                        };

                        document.onmouseup = function() {
                            document.onmousemove = null
                            document.onmouseup = null
                        };
                        return false
                    }
                }

                const onresize = function() {
                    if(!_this.value) return
                    _this.initPostion()
                    resize(frame, resizeBar, false, false, false, false)
                    const docElement = document.documentElement
                    position.left = (docElement.clientWidth - 800) / 2 + "px";
                    position.top = (docElement.clientHeight - parseInt(_this.position.height)) / 2 + "px";
                    _this.setFramePosition({
                        width: '800px',
                        height: `${parseInt(_this.position.height)}px`,
                        left: position.left,
                        top: position.top
                    })
                }

                window.onresize = onresize
                onresize()
            },
            handleGetIndex () {
                transferIncrease()
                this.transferIndex = transferIndex
            },
            initRevert() {
                if(!this.enableResize) return
                const handle = this.$refs.dragBar
                const _this = this
                let last = {}
                let isMax = false
                handle.ondblclick = function() {
                    if(!isMax) {
                        last = _this.position
                        isMax = true
                        _this.setFramePosition({
                            left: '0',
                            top: '0',
                            width: '100%',
                            height: '100%',
                        }) 

                    } else {
                        isMax = false
                        _this.setFramePosition(last) 
                    }
                }
            },
            initPostion() {
                const wrapper = this.$refs.selectWrapper
                const wrapperHeight = wrapper.offsetHeight > 750 ? 750 : wrapper.offsetHeight
                const position = {
                    width: '800px',
                    height: `${wrapperHeight * .8}px`,
                    minWidth: '800px',
                    minHeight: `${wrapperHeight * .8}px`,
					left: '50%',
                    top: '50%',
                    marginLeft: '-400px',
                    marginTop: `-${wrapperHeight * .8/2}px`
                }
                this.position = position
                
            },
            init() {
                this.initPostion()
                this.initDrag()
                this.initResize()
                this.initRevert()
            }
        },
        mounted() {
            // this.init()
        }
    }
</script>


